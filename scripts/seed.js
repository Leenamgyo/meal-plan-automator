#!/usr/bin/env node
/**
 * SQLite ë¡œì»¬ DB ë”ë¯¸ ë°ì´í„° ì‹œë“œ ìŠ¤í¬ë¦½íŠ¸
 * ì‚¬ìš©ë²•: node scripts/seed.js [API_URL]
 * ê¸°ë³¸ URL: http://127.0.0.1:3737/api
 *
 * ë¡œì»¬ SQLite DB ì„œë²„ì— ì•„ë˜ ë°ì´í„°ê°€ ì—°ë™ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
 *   categories: name, color
 *   menu_items: name, category_id, ingredients
 *   meal_data: date, menus
 *
 * ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œ í›„ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤ (í…ŒìŠ¤íŠ¸ìš©).
 */

const API_URL = process.argv[2] || 'http://127.0.0.1:3737/api';

const categories = [
    { name: 'ë°¥', color: '#f08c00' },
    { name: 'êµ­/ì°Œê°œ', color: '#e8590c' },
    { name: 'ì£¼ë©”ë‰´', color: '#ff6b6b' },
    { name: 'ë¶€ë©”ë‰´', color: '#339af0' },
    { name: 'ë°‘ë°˜ì°¬', color: '#20c997' },
    { name: 'ê¹€ì¹˜/ê¸°íƒ€', color: '#845ef7' },
];

const rawMenus = {
    'ë°¥': [
        'ìŒ€ë°¥', 'í˜„ë¯¸ë°¥', 'í‘ë¯¸ë°¥', 'ê¸°ì¥ë°¥', 'ì½©ë°¥', 'ì¡ê³¡ë°¥', 'ë³¶ìŒë°¥', 'ë¹„ë¹”ë°¥', 'ë³´ë¦¬ë°¥', 'ì™„ë‘ì½©ë°¥',
        'ìˆ˜ìˆ˜ë°¥', 'ê·€ë¦¬ë°¥', 'ë°¤ë°¥', 'ë‚˜ë¬¼ë°¥', 'ê³¤ë“œë ˆë‚˜ë¬¼ë°¥', 'ì·¨ë‚˜ë¬¼ë°¥', 'ë¬´ë°¥', 'ì½©ë‚˜ë¬¼ë°¥', 'ì˜ì–‘ëŒì†¥ë°¥', 'ë²„ì„¯ë°¥'
    ],
    'êµ­/ì°Œê°œ': [
        'ëœì¥ì°Œê°œ', 'ê¹€ì¹˜ì°Œê°œ', 'ë¯¸ì—­êµ­', 'ì½©ë‚˜ë¬¼êµ­', 'ì†Œê³ ê¸°ë¬´êµ­', 'ì‹œê¸ˆì¹˜ëœì¥êµ­', 'ìˆœë‘ë¶€ì°Œê°œ', 'ë¶€ëŒ€ì°Œê°œ', 'ì²­êµ­ì¥', 'ê°ìíƒ•',
        'ë¼ˆí•´ì¥êµ­', 'ì–´ë¬µêµ­', 'ê³„ë€êµ­', 'í™í•©íƒ•', 'ë™íƒœì°Œê°œ', 'ìœ¡ê°œì¥', 'ê°ˆë¹„íƒ•', 'ì„¤ë íƒ•', 'ê³°íƒ•', 'ì‚¼ê³„íƒ•',
        'ë¶ì—‡êµ­', 'ì˜¤ì§•ì–´êµ­', 'ê½ƒê²Œíƒ•', 'ì•„ìš±êµ­', 'ë°°ì¶”ëœì¥êµ­', 'ë–¡êµ­', 'ë§Œë‘£êµ­', 'ìˆ˜ì œë¹„', 'ì¹¼êµ­ìˆ˜', 'ìš°ê±°ì§€í•´ì¥êµ­',
        'ì„ ì§€í•´ì¥êµ­', 'í™©íƒœí•´ì¥êµ­', 'ì°¨ëŒëœì¥ì°Œê°œ', 'í•´ë¬¼ìˆœë‘ë¶€', 'ì•Œíƒ•', 'ë™ì£½ì¡°ê°œíƒ•', 'ëŒ€êµ¬íƒ•', 'ë§¤ìƒì´êµ´êµ­', 'ë‹¤ìŠ¬ê¸°êµ­', 'ê¹€ì¹«êµ­'
    ],
    'ì£¼ë©”ë‰´': [
        'ì œìœ¡ë³¶ìŒ', 'ì†Œë¶ˆê³ ê¸°', 'ë‹­ê°ˆë¹„', 'ì˜¤ì§•ì–´ë³¶ìŒ', 'ê³ ë“±ì–´ì¡°ë¦¼', 'ê°ˆì¹˜ì¡°ë¦¼', 'ê½ì¹˜ê¹€ì¹˜ì¡°ë¦¼', 'ë‹­ë³¶ìŒíƒ•', 'ê°„ì¥ì°œë‹­', 'ëˆê¹ŒìŠ¤',
        'íƒ•ìˆ˜ìœ¡', 'ë³´ìŒˆ', 'ì¡±ë°œ', 'ì‚¼ê²¹ì‚´êµ¬ì´', 'í›ˆì œì˜¤ë¦¬', 'ì†Œê°ˆë¹„ì°œ', 'ë¼ì§€ê°ˆë¹„ì°œ', 'í•´ë¬¼ì°œ', 'ì•„ê·€ì°œ', 'ì½”ë‹¤ë¦¬ì¡°ë¦¼',
        'ë§ˆíŒŒë‘ë¶€', 'ì­ˆê¾¸ë¯¸ë³¶ìŒ', 'ë‚™ì§€ë³¶ìŒ', 'ê³ ì¶”ì¥ë¶ˆê³ ê¸°', 'ê°„ì¥ë¶ˆê³ ê¸°', 'ê¹í’ê¸°', 'ê³ ë“±ì–´êµ¬ì´', 'ì‚¼ì¹˜êµ¬ì´', 'ê°€ìë¯¸êµ¬ì´', 'ì¡°ê¸°êµ¬ì´',
        'ê°ˆì¹˜êµ¬ì´', 'ë–¡ê°ˆë¹„', 'í•¨ë°•ìŠ¤í…Œì´í¬', 'ì˜¤ë¦¬ì£¼ë¬¼ëŸ­', 'ë¼ì§€ê³ ê¸°ê¹€ì¹˜ì°œ', 'ì¹´ë ˆë¼ì´ìŠ¤', 'ì§œì¥ë°¥', 'ë§ˆë¼ìƒ¹ê¶ˆ', 'ìœ ì‚°ìŠ¬', 'íŒ”ë³´ì±„',
        'ë™íŒŒìœ¡', 'ê¹ì‡¼ìƒˆìš°', 'ì°¹ìŠ¤í…Œì´í¬', 'ì†Œì„¸ì§€ì•¼ì±„ë³¶ìŒ', 'ì¹˜ì¦ˆë‹­ê°ˆë¹„'
    ],
    'ë¶€ë©”ë‰´': [
        'ê³„ë€ë§ì´', 'ê³„ë€ì°œ', 'ë‘ë¶€ë¶€ì¹¨', 'ë‘ë¶€ì¡°ë¦¼', 'ì–´ë¬µë³¶ìŒ', 'ë–¡ë³¶ì´', 'ìŠ¤íŒ¸êµ¬ì´', 'ë² ì´ì»¨ìˆ™ì£¼ë³¶ìŒ', 'ì§„ë¯¸ì±„ë³¶ìŒ', 'ë©¸ì¹˜ë³¶ìŒ',
        'ì¥í¬ë³¶ìŒ', 'ë§ˆëŠ˜ì«‘ìƒˆìš°ë³¶ìŒ', 'ë©”ì¶”ë¦¬ì•Œì¥ì¡°ë¦¼', 'ì†Œê³ ê¸°ì¥ì¡°ë¦¼', 'ë¼ì§€ê³ ê¸°ì¥ì¡°ë¦¼', 'ë¶„í™ì†Œì‹œì§€ì „', 'ë™ê·¸ë‘ë•¡', 'ìƒì„ ê¹ŒìŠ¤', 'ê°ìì±„ë³¶ìŒ', 'ë‹¨í˜¸ë°•ë²”ë²…',
        'ì¡ì±„', 'ì½˜ì¹˜ì¦ˆ', 'ë§ˆì¹´ë¡œë‹ˆìƒëŸ¬ë“œ', 'ì•¼ì±„íŠ€ê¹€', 'ê³ êµ¬ë§ˆíŠ€ê¹€', 'ê¹€ë§ì´íŠ€ê¹€', 'ìƒˆìš°íŠ€ê¹€', 'ì˜¤ì§•ì–´íŠ€ê¹€', 'ë„ˆë¹„ì•„ë‹ˆêµ¬ì´', 'ë‘ë¶€ê¹€ì¹˜',
        'ë„í† ë¦¬ë¬µë¬´ì¹¨', 'ì²­í¬ë¬µë¬´ì¹¨', 'ì˜¤ê¼¬ë…¸ë¯¸ì•¼ë¼', 'ìˆœëŒ€ë³¶ìŒ', 'ë§Œë‘íƒ•ìˆ˜', 'ê³ ì¶”ì¡ì±„', 'ì—°ì–´êµ¬ì´', 'ì°¸ì¹˜ê¹€ì¹˜ë³¶ìŒ', 'ìƒˆì†¡ì´ë²„ì„¯ì „', 'ì• í˜¸ë°•ì „',
        'ê¹€ì¹˜ì „', 'í•´ë¬¼íŒŒì „', 'ë¶€ì¶”ì „', 'ê±´ìƒˆìš°ë³¶ìŒ', 'ì—°ê·¼ì¡°ë¦¼', 'ìš°ì—‰ì¡°ë¦¼', 'ì˜¤ì§•ì–´ì´ˆë¬´ì¹¨', 'ê³¨ë±…ì´ë¬´ì¹¨', 'ë¹„ì—”ë‚˜ì†Œì‹œì§€ë³¶ìŒ', 'ë§›ì‚´ë³¶ìŒ'
    ],
    'ë°‘ë°˜ì°¬': [
        'ì‹œê¸ˆì¹˜ë‚˜ë¬¼', 'ì½©ë‚˜ë¬¼ë¬´ì¹¨', 'ìˆ™ì£¼ë‚˜ë¬¼', 'ê³ ì‚¬ë¦¬ë‚˜ë¬¼', 'ë„ë¼ì§€ë¬´ì¹¨', 'ë¯¸ë‚˜ë¦¬ë¬´ì¹¨', 'ì·¨ë‚˜ë¬¼ë³¶ìŒ', 'ì°¸ë‚˜ë¬¼ë¬´ì¹¨', 'ìœ ì±„ë‚˜ë¬¼', 'ë¬´ìƒì±„',
        'ì˜¤ì´ë¬´ì¹¨', 'ê°€ì§€ë³¶ìŒ', 'ê°€ì§€ë¬´ì¹¨', 'ì• í˜¸ë°•ë³¶ìŒ', 'ë¯¸ì—­ì¤„ê¸°ë³¶ìŒ', 'íŒŒë˜ë¬´ì¹¨', 'í†³ë¬´ì¹¨', 'ì˜¤ì´ê³ ì¶”ëœì¥ë¬´ì¹¨', 'ë§ˆëŠ˜ì«‘ë¬´ì¹¨', 'ë§ˆëŠ˜ì¥ì•„ì°Œ',
        'ê¹»ìì¥ì•„ì°Œ', 'ì–‘íŒŒì¥ì•„ì°Œ', 'ê³ ì¶”ì¥ì•„ì°Œ', 'ê±´ê°€ì§€ë‚˜ë¬¼', 'ë¬´ë§ë­ì´ë¬´ì¹¨'
    ],
    'ê¹€ì¹˜/ê¸°íƒ€': [
        'ë°°ì¶”ê¹€ì¹˜', 'ê¹ë‘ê¸°', 'ì—´ë¬´ê¹€ì¹˜', 'ì´ê°ê¹€ì¹˜', 'íŒŒê¹€ì¹˜', 'ê°“ê¹€ì¹˜', 'ë™ì¹˜ë¯¸', 'ë°±ê¹€ì¹˜', 'ë‚˜ë°•ê¹€ì¹˜', 'ë¶€ì¶”ê¹€ì¹˜',
        'ì˜¤ì´ì†Œë°•ì´', 'ê²‰ì ˆì´', 'ë³¶ìŒê¹€ì¹˜', 'ë¬¼ê¹€ì¹˜', 'ê¹»ìê¹€ì¹˜', 'ê³ ë“¤ë¹¼ê¸°ê¹€ì¹˜', 'ë¬µì€ì§€ë³¶ìŒ', 'ë³´ìŒˆê¹€ì¹˜', 'ì„ë°•ì§€', 'ë‹¨ë¬´ì§€ë¬´ì¹¨'
    ]
};

// ========== Helper ==========

async function fetchAllRecords(endpoint) {
    try {
        const res = await fetch(`${API_URL}/${endpoint}`);
        if (!res.ok) return [];
        return await res.json();
    } catch (err) {
        return [];
    }
}

async function deleteAllRecords(endpoint, idField = 'id') {
    const records = await fetchAllRecords(endpoint);
    if (!records || records.length === 0) {
        console.log(`  (ë¹„ì–´ìˆìŒ)`);
        return 0;
    }
    let deleted = 0;
    for (const r of records) {
        const res = await fetch(`${API_URL}/${endpoint}/${r[idField]}`, { method: 'DELETE' });
        if (res.ok) deleted++;
    }
    console.log(`  ğŸ—‘ï¸ ${deleted}/${records.length}ê°œ ì‚­ì œ`);
    return deleted;
}

// ========== Main ==========

async function main() {
    console.log(`ğŸ”Œ API URL: ${API_URL}`);

    // Health check
    try {
        // Just check if categories endpoint responds
        const res = await fetch(`${API_URL}/categories`);
        if (!res.ok) throw new Error(`status ${res.status}`);
        console.log('âœ… ë¡œì»¬ API ì„œë²„ ì—°ê²° ì„±ê³µ\n');
    } catch (err) {
        console.error('âŒ ë¡œì»¬ API ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', err.message);
        console.error('ë¨¼ì € ì•±ì´ ì‹¤í–‰ë˜ì–´ ë¡œì»¬ ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
        process.exit(1);
    }

    // Step 1: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ
    console.log('ğŸ§¹ ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘...');
    console.log('  [meal-data]');
    await deleteAllRecords('meal-data', 'date'); // meal-data uses 'date' for deletion
    console.log('  [menu-items]');
    await deleteAllRecords('menu-items');
    console.log('  [categories]');
    await deleteAllRecords('categories');

    // Step 2: ì¹´í…Œê³ ë¦¬ ìƒì„±
    console.log('\nğŸ“ ì¹´í…Œê³ ë¦¬ ìƒì„± ì¤‘...');
    const catMap = {}; // name -> SQLite auto ID
    for (const cat of categories) {
        try {
            const res = await fetch(`${API_URL}/categories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cat),
            });
            const data = await res.json();
            if (res.ok) {
                catMap[cat.name] = data.id;
                console.log(`  âœ… ${cat.name} â†’ id: ${data.id}`);
            } else {
                console.log(`  âš ï¸ ${cat.name}: ${JSON.stringify(data)}`);
            }
        } catch (err) {
            console.error(`  âŒ ${cat.name}: ${err.message}`);
        }
    }

    // Step 3: ë©”ë‰´ ìƒì„± (category_id í•„ë“œì— SQLite auto ID ì‚¬ìš©)
    console.log('\nğŸ½ï¸ ë©”ë‰´ ìƒì„± ì¤‘...');
    let total = 0;
    let success = 0;
    for (const [catName, menus] of Object.entries(rawMenus)) {
        const categoryId = catMap[catName];
        if (!categoryId) {
            console.log(`  âš ï¸ ì¹´í…Œê³ ë¦¬ "${catName}" IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ, ê±´ë„ˆëœ€`);
            continue;
        }
        for (const name of menus) {
            total++;
            try {
                const res = await fetch(`${API_URL}/menu-items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category_id: categoryId,
                        ingredients: [],
                    }),
                });
                if (res.ok) {
                    success++;
                } else {
                    const data = await res.text();
                    console.log(`  âš ï¸ ${name}: ${data}`);
                }
            } catch (err) {
                console.error(`  âŒ ${name}: ${err.message}`);
            }
        }
        console.log(`  ğŸ“¦ ${catName}: ${menus.length}ê°œ ì²˜ë¦¬`);
    }

    console.log(`\nğŸ‰ ì™„ë£Œ! ì¹´í…Œê³ ë¦¬ ${Object.keys(catMap).length}ê°œ, ë©”ë‰´ ${success}/${total}ê°œ ìƒì„±`);
}

main();
